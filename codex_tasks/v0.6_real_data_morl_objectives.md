# v0.6 â€” Real-data readiness for MORL objectives (TTT + Coverage)

You are working in repo `Gatra-comparison` on top of tag `v0.5.1` (Meta-controller shipped).
Goal: make MORL use real-data-derived objectives in a contract-only way.

## Constraints
- Contract-only evaluation: MORL eval must not call BigQuery.
- Deterministic and reproducible via existing seeds plumbing.
- CI-safe: tests must not require pyarrow; must not require BigQuery auth.
- Backward compatible: toy data must still work.
- Strict typing (mypy) and ruff clean.

## Inputs available (real export)
Local CSV config exists:
- configs/data_local_gatra_prd_c335.yaml
Local CSVs (not committed):
- data/local/gatra_prd_c335/activity_logs_base.csv
- data/local/gatra_prd_c335/ada_feedback.csv

Columns known in activity_logs_base.csv:
- row_key, event_timestamp_epoch_s, event_timestamp, session_id, user, action, page, details

## Deliverables

A) Contract export must include episode/session metadata (aligned to arrays)
Add arrays under contract dir for each split:
- session_id_{train,val,test}.npy  (dtype: fixed-width string or object)
- user_{train,val,test}.npy        (optional but recommended)
Add meta.json:
"episodes": {
  "source": "activity_logs_base.csv",
  "keys": ["session_id","user"],
  "files": ["session_id_train.npy",...]
}
Alignment invariant:
len(session_id_split) == len(y_split) == len(timestamps_epoch_s_split)

B) Objective extraction module (contract-only)
Create `architecture_a_rl/morl/objectives_realdata.py`:
- Build per-split objective signals from contract arrays + event fields
- Must support Level-1 objectives:
  1) time_to_triage_seconds (minimize)
     - computed per session_id within the split:
       TTT(session)=max(ts)-min(ts)
     - assign each event in session the same TTT value (or normalized session-level value)
  2) detection_coverage (maximize)
     - define interaction coverage as novelty rate within a session:
       coverage_increment = 1 when (page,action) first appears in that session, else 0
     - aggregate in episode metrics and produce per-step reward component
- Outputs should be written to contract/eval artifacts:
  - objectives_{split}.npz (contains per-row vectors for objectives)
  - objectives_meta.json (definitions, normalization)

C) MORL pipeline integration
Update MORL trainer/eval so objectives are not purely synthetic:
- When contract contains session_id_* and page/action fields or encoded feature mapping:
  - Use objectives_realdata.py to compute objective components for reward
- If missing required fields, fall back to existing objective computation (toy/synthetic).

D) Reporting updates
Update morl_report.py to include:
- Definitions of TTT and Coverage (Level-1)
- Summary stats on VAL and TEST:
  - median/p90 TTT
  - coverage per 1k events and/or novelty rate
- Make it clear whether Level-1 or fallback objectives were used.

E) Tests (CI-safe, no pyarrow)
Add tests using small in-memory numpy arrays:
1) test_objectives_ttt.py
   - two sessions with known timestamps -> TTT computed correctly
2) test_objectives_coverage.py
   - page/action novelty increments computed correctly
3) test_objectives_alignment.py
   - raises clear error if session_id length mismatches y length

F) Config
Add MORL config examples:
- configs/morl_realdata.yaml: sets objectives=[time_to_triage, coverage] and normalization strategy
- Document how to run real-data MORL using local CSV config (without committing data files).

## Commit Plan (exactly)
1) feat(v0.6): export session_id arrays in frozen contract
2) feat(v0.6): real-data MORL objective extraction (TTT + coverage)
3) feat(v0.6): integrate real-data objectives into MORL train/eval + reporting
4) test(v0.6): add objective unit tests (CI-safe)
5) docs(v0.6): add real-data MORL run instructions + objective definitions

## Quality Gate
Run:
- make format
- make lint
- make test
All must pass.

## Output
- Create branch: v0.6-realdata-morl
- Push branch
- Open PR titled: "v0.6: real-data MORL objectives (time-to-triage + coverage)"
Include in PR description: how to run using configs/data_local_gatra_prd_c335.yaml (data not committed).

## How to run (after v0.6 lands)

Quick run using local export (data not committed):
```bash
make run_morl_quick DATA_CONFIG=configs/data_local_gatra_prd_c335.yaml MORL_CONFIG=configs/morl_realdata.yaml
```

Explicit:
```bash
PYTHONPATH=. python3.11 -m runs.cli \
  --data-config configs/data_local_gatra_prd_c335.yaml \
  --ppo-config configs/ppo.yaml \
  --morl-config configs/morl_realdata.yaml \
  --meta-config configs/meta_controller.yaml \
  --out-root reports/runs \
  --quick
```
