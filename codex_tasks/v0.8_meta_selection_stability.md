# v0.8 â€” Meta-selection stability suite (Option 2 hardening)

You are working in repo `Gatra-comparison` on top of tag `v0.7.0` (or current main if newer).
Goal: Add a deterministic, contract-only stability suite for the meta-controller selection process.

## Constraints
- Contract-only: must NOT call BigQuery.
- Deterministic: must respect seed plumbing (run seeds + meta-controller seeds).
- CI-safe: tests must not require pyarrow; no BigQuery auth in tests.
- Backward compatible: current `make run_morl_policy_quick` behavior must not change.
- Strict typing: mypy strict must stay green; ruff clean.

## Inputs
- Existing meta selection artifacts:
  - eval/morl/meta_selection.json
  - eval/morl/meta_feasibility.json
  - eval/morl/morl_results_val.json (or equivalent VAL results table)
- Existing robustness variants and label realism already exist in repo:
  - evaluation/robustness.py
  - evaluation/label_availability.py (created-at gating)
  - evaluation/policy_eval.py

## Deliverables
A) New stability runner:
- Add `evaluation/meta_stability.py` that:
  1) Loads base MORL sweep results (VAL) and candidate weights.
  2) Replays meta-controller selection across a grid of "conditions":
     - baseline
     - robustness variants (subset): missing_mcar_20, noise_medium, time_slice:early, time_slice:late
     - label availability: delay=1d, delay=7d (created-at gating path)
     - policy regimes: alert_budget=10/20/30 per 1k (or derived)
  3) For each condition:
     - select weights using meta-controller (respect mode/relax schedule)
     - record whether fallback used, mode used, relax trace length
     - record selected metrics (recall, pr_auc, alerts_per_1k, ttt if present)
     - compute regret vs best available candidate under that condition:
       regret = utility(best_candidate) - utility(selected)
       where utility is consistent with current objective direction conventions.
  4) Compute aggregate stability metrics across all conditions:
     - selection_change_rate
     - avg_weight_L1_distance
     - constraint_violation_rate
     - avg_regret
  5) Write artifacts under eval/meta_stability/:
     - meta_stability.json
     - meta_stability.md
     - meta_stability_table.csv

B) CLI integration:
- Add flags to `runs/cli.py`:
  - `--meta-stability-config` optional (yaml)
- Ensure suite can be run without training by using existing contract + exported eval artifacts.
- Add manifest fields:
  - meta_stability_config_hash
  - meta_stability_output_path

C) Config:
- Add `configs/meta_stability.yaml` defining:
  - conditions list
  - which robustness variants to include
  - label delay durations list
  - policy regimes list
  - utility definition for regret (explicit)

D) Make targets:
- Add to Makefile:
  - `meta_stability`
  - `run_meta_stability_quick`
- Use existing $(PY) and PYTHONPATH hardening.

E) Tests:
- Add CI-safe tests (pure numpy):
  - `tests/test_meta_stability_metrics.py` checks:
    - selection_change_rate is computed correctly
    - weight distance works
    - regret computed with correct sign conventions
  - `tests/test_meta_stability_smoke.py`:
    - builds tiny fake candidate set + fake condition metrics table
    - runs suite end-to-end without pyarrow and writes artifacts

## Notes
- Keep condition replay deterministic: any sampling must be seeded.
- If a condition cannot be evaluated due to missing artifacts, suite should:
  - mark condition "skipped" with a reason
  - still produce overall report
- Ensure markdown report is readable and explicitly includes:
  - list of conditions
  - table of selected weights per condition
  - volatility summary
  - worst-case regret and which condition caused it

## Commit Plan
1) feat(v0.8): add meta-stability suite runner + artifacts
2) feat(v0.8): integrate meta-stability into CLI + manifest
3) build(v0.8): add Make targets + configs
4) test(v0.8): add stability tests
5) docs(v0.8): add morl.md section explaining stability suite

## Quality Gate
- make format
- make lint
- make test

## Output
- Create branch: v0.8-meta-stability
- Push branch
- Open PR titled: "v0.8: meta-selection stability suite"
- PR must include:
  - how to run: make meta_stability
  - where artifacts land
  - interpretation guidance
