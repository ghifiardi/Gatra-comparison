# v0.6.1 â€” MORL objective normalization + scaling controls (TTT + Coverage)

Repo: `Gatra-comparison`
Base: tag `v0.6.0` (real-data MORL objectives shipped)
Goal: make MORL objective signals comparable and robust by adding normalization and capping.

## Constraints
- Contract-only: MUST NOT call BigQuery at runtime.
- Deterministic: use existing seed plumbing; derived stats are deterministic.
- CI-safe: no pyarrow requirement; no BigQuery auth.
- Backward compatible:
  - Existing MORL runs without normalization config behave as before (`norm: none`).
- Strict typing (mypy) and ruff clean.

## Deliverables

### A) Add normalization config
1) `configs/morl_realdata_normalized.yaml`:
- Objective-level controls:
  - `time_to_triage_seconds`: `direction=minimize`, `norm=log1p_zscore`, `cap_pctl=0.99`
  - `detection_coverage`: `direction=maximize`, `norm=rate_per_1k_zscore`, `cap_pctl=0.99`
- Global normalization:
  - `reference_split: val`
  - `apply_to: [val, test]`
  - `eps: 1e-8`
  - `clip_z: 5.0`
  - `persist: true`
2) Keep `configs/morl_realdata.yaml` as unnormalized baseline (`norm: none`).

### B) Implement normalizer utilities (contract-only)
Create `architecture_a_rl/morl/objectives_normalize.py` with:
- dataclasses:
  - `NormalizationSpec`
  - `ObjectiveSpec`
  - `NormalizationStats`
- functions:
  - `winsorize`
  - `compute_stats`
  - `apply_zscore`
  - `log1p_then_zscore`
  - `rate_per_1k`

### C) Integrate normalization into real-data objective pipeline
Update `architecture_a_rl/morl/objectives_realdata.py`:
- normalize raw objective signals when configured
- compute stats on `reference_split` only
- apply same stats on configured splits (`val`/`test`)
- persist `objectives_norm.json`
- enrich `objectives_meta.json` with normalization summary and cap thresholds

### D) Reporting enhancements
Update `evaluation/morl_report.py`:
- display normalization table (norm/cap/mean/std/clip settings)
- show raw and normalized summary stats
- state clearly which reward signal variant was used

### E) CLI wiring
Update MORL pipeline integration so normalization config is honored from `--morl-config` and recorded in run manifest summary.

### F) Tests
Add CI-safe numpy tests:
- `test_objective_winsorize.py`
- `test_objective_zscore_clip.py`
- `test_objective_norm_refsplit.py`
- `test_objective_rate_per_1k.py`

## Commit plan
1) feat(v0.6.1): add MORL normalized config example
2) feat(v0.6.1): add objective normalization utilities
3) feat(v0.6.1): apply normalization in real-data objective pipeline + persist stats
4) feat(v0.6.1): enhance MORL reporting with raw vs normalized stats
5) test(v0.6.1): add normalization unit tests
6) docs(v0.6.1): document normalization usage in morl.md

## Quality gate
- `make format`
- `make lint`
- `make test`

## Output
- Branch: `v0.6.1-objective-normalization`
- PR title: `v0.6.1: MORL objective normalization + scaling controls`
- Include baseline vs normalized run examples and contract-only guarantee in PR body.
